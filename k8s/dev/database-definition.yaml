apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: dev
  labels:
    module: db-postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      module: db-postgres
  template:
    metadata:
      labels:
        module: db-postgres
    spec:

      # ðŸ”¹ INIT CONTAINER
      initContainers:
        - name: init-db
          image: postgres:18.1-alpine
          env:
            - name: PGPASSWORD
              value: "password"
          command:
            - sh
            - -c
            - |
              echo "Waiting for PostgreSQL to be ready..."
              until pg_isready -h postgres -p 5432 -U postgres; do
                sleep 2
              done

              echo "PostgreSQL is ready. Initializing database..."

              psql -h postgres -U postgres -d kubecoin <<EOF
              CREATE TABLE IF NOT EXISTS wallets (
                  id VARCHAR(255) PRIMARY KEY,
                  balance DECIMAL(15, 2) DEFAULT 1000.00,
                  coins DECIMAL(15, 2) DEFAULT 0.00,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
              );

              CREATE INDEX IF NOT EXISTS idx_wallets_id ON wallets(id);
              EOF

      # ðŸ”¹ MAIN POSTGRES CONTAINER
      containers:
        - name: postgres
          image: postgres:18.1-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              value: "postgres"
            - name: POSTGRES_PASSWORD
              value: "password"
            - name: POSTGRES_DB
              value: "kubecoin"
